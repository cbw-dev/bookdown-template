name: Setup Workshop from Config

# --- CHANGE: Trigger when the config file is pushed ---
on:
  push:
    paths:
      - 'workshop_config.json'

jobs:
  replace-variables:
    if: github.repository != 'cbw-dev/bookdown-template'
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- CHANGE: Read variables from the JSON file ---
      - name: Load Variables from Config
        id: vars
        run: |
          # This uses the 'jq' tool to parse JSON and set outputs for the job
          echo "WORKSHOP_CODE=$(jq -r .workshop_code workshop_config.json)" >> $GITHUB_ENV
          echo "WORKSHOP_NAME=$(jq -r .workshop_name workshop_config.json)" >> $GITHUB_ENV
          echo "YEAR=$(jq -r .year workshop_config.json)" >> $GITHUB_ENV
          echo "URL=$(jq -r .url workshop_config.json)" >> $GITHUB_ENV
          echo "DATES=$(jq -r .dates workshop_config.json)" >> $GITHUB_ENV
          echo "FACULTY=$(jq -r .faculty workshop_config.json)" >> $GITHUB_ENV

      - name: Rename .Rproj file
        run: mv template.Rproj ${{ env.WORKSHOP_CODE }}.Rproj

      - name: Replace All Placeholders
        run: |
          find . -type f -not -path './.git/*' -not -path './.github/*' -exec sed -i \
            -e "s|{{WORKSHOP_CODE}}|${WORKSHOP_CODE}|g" \
            -e "s|{{WORKSHOP_NAME}}|${WORKSHOP_NAME}|g" \
            -e "s|{{YEAR}}|${YEAR}|g" \
            -e "s|{{URL}}|${URL}|g" \
            -e "s|{{DATES}}|${DATES}|g" \
            -e "s|{{FACULTY}}|${FACULTY}|g" \
            {} +

      - name: Clean up config file
        run: rm workshop_config.json

      - name: Commit and Push Changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # Add all changes, including the deletion of the config file
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            # Amend the initial commit so the history is clean
            git commit --amend -m "feat: setup workshop with custom variables"
            git push --force
          fi
