name: Setup Workshop from Config

on:
  push:
    paths:
      - 'workshop_config.json'

jobs:
  replace-variables:
    if: github.repository != 'YOUR_ORG/YOUR_TEMPLATE_REPO_NAME'
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Load Variables from Config
        run: |
          echo "WORKSHOP_CODE=$(jq -r .workshop_code workshop_config.json)" >> $GITHUB_ENV
          echo "WORKSHOP_NAME=$(jq -r .workshop_name workshop_config.json)" >> $GITHUB_ENV
          echo "YEAR=$(jq -r .year workshop_config.json)" >> $GITHUB_ENV
          echo "URL=$(jq -r .url workshop_config.json)" >> $GITHUB_ENV
          echo "DATES=$(jq -r .dates workshop_config.json)" >> $GITHUB_ENV
          echo "FACULTY=$(jq -r .faculty workshop_config.json)" >> $GITHUB_ENV

      # --- CHANGE: Added an 'if' condition to the following steps ---
      - name: Rename .Rproj file
        if: env.WORKSHOP_CODE != 'ENTER_WORKSHOP_CODE_HERE'
        # Added quotes for safety
        run: mv template.Rproj "${{ env.WORKSHOP_CODE }}.Rproj"

      - name: Replace All Placeholders
        if: env.WORKSHOP_CODE != 'Workshop Code (e.g. INR_Mon2510)'
        run: |
          find . -type f -not -path './.git/*' -not -path './.github/*' -exec sed -i \
            -e "s|{{WORKSHOP_CODE}}|${WORKSHOP_CODE}|g" \
            -e "s|{{WORKSHOP_NAME}}|${WORKSHOP_NAME}|g" \
            -e "s|{{YEAR}}|${YEAR}|g" \
            -e "s|{{URL}}|${URL}|g" \
            -e "s|{{DATES}}|${DATES}|g" \
            -e "s|{{FACULTY}}|${FACULTY}|g" \
            {} +
            
      - name: Clean up config file
        if: env.WORKSHOP_CODE != 'ENTER_WORKSHOP_CODE_HERE'
        run: rm workshop_config.json
        
      - name: Commit and Push Changes
        if: env.WORKSHOP_CODE != 'ENTER_WORKSHOP_CODE_HERE'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit --amend -m "feat: setup workshop with custom variables"
            git push --force
          fi